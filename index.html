<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Reminder System â€” Demo</title>
  <meta name="description" content="Frontend demo of an Email Reminder System (client-side scheduling, mailto integration, localStorage)." />
  <style>
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      background: linear-gradient(180deg,#0f172a 0%, #071028 100%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }
    .container{
      width:100%;
      max-width:1100px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.04);
      border-radius:14px;
      padding:22px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    }
    header{
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:14px}
    header h1{font-size:20px;
      margin:0}
    header p{
      margin:0;
      color:#9fb4d6;
      font-size:13px}

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:18px;
    }
    .card{
      background:rgba(255,255,255,0.02);
      border-radius:10px;
      padding:14px;
      border:1px solid rgba(255,255,255,0.03)
    }
    label{display:block;
      font-size:13px;
      color:#bcd7ff;
      margin-bottom:6px}
    input[type="text"], input[type="email"], input[type="datetime-local"], select, textarea{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.02);
      color:inherit;
      font-size:14px;
    }
    textarea{min-height:96px;
      resize:vertical}
    .row{display:flex;
      gap:10px}
    .row > *{flex:1}
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:8px;
      border:0;
      background:#0ea5e9;
      color:#032033;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 6px 18px rgba(14,165,233,0.12);
    }
    select {
      border-radius: 8px;
      padding: 10px;
    }
    select option {
      color: black;           
    }
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe9ff}
    .btn.danger{background:#ef4444;color:#fff;box-shadow:none}

    .small{font-size:13px;color:#9fb4d6}
    .muted{color:#93b3d6;font-size:13px}
    .list{display:flex;flex-direction:column;gap:10px}
    .reminder{
      display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    }
    .rem-left{display:flex;gap:12px;align-items:center}
    .avatar{
      width:52px;height:52px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;
      background:linear-gradient(135deg,#06b6d4,#7c3aed);color:white;font-size:15px;
    }
    .meta{min-width:0}
    .meta h3{margin:0;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta p{margin:0;font-size:13px;color:#9fb4d6}
    .actions{display:flex;gap:8px;align-items:center}
    .pill{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01)}
    .due{background:linear-gradient(90deg,#ff8a8a,#ff5a5a);color:#2b0b0b;border:0}
    footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .controls{display:flex;gap:10px;align-items:center}
    @media (max-width:920px){
      .grid{grid-template-columns:1fr;align-items:start}
      header{flex-direction:column;align-items:flex-start;gap:6px}
    }
    .muted-block{background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.02);color:#9fb4d6;font-size:13px}
    .danger-text{color:#ffb4b4;font-weight:600}
  </style>
</head>
<body>
  <div class="container" role="application" aria-labelledby="appTitle">
    <header>
      <div>
        <h1 id="appTitle">Email Reminder System </h1>
        
      </div>
      <div style="margin-left:auto;text-align:right">
        <p class="small muted">Status: <span id="status">Idle</span></p>
        <p class="small muted">Scheduler: <span id="schedulerState">Running</span></p>
      </div>
    </header>
    <div class="grid" role="main">
      <section class="card" aria-label="Create or edit reminder">
        <h2 style="margin-top:0;margin-bottom:6px">Create / Edit Reminder</h2>

        <form id="remForm" onsubmit="return false" autocomplete="off" aria-describedby="formHint">
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
            <div style="flex:1">
              <label for="recipient">Recipient Email</label>
              <input id="recipient" type="email" required placeholder="friend@example.com" />
            </div>
            <div style="width:120px">
              <label for="priority">Priority</label>
              <select id="priority" aria-label="priority selector">
                <option value="normal">Normal</option>
                <option value="high">High</option>
                <option value="low">Low</option>
              </select>
            </div>
          </div>
          <label for="subject">Subject</label>
          <input id="subject" type="text" placeholder="Subject for email" required />
          <label for="message">Message</label>
          <textarea id="message" placeholder="Write the email body..." required></textarea>
          <div style="display:flex;gap:10px;margin-top:8px;align-items:center">
            <div style="flex:1">
              <label for="when">Date & time</label>
              <input id="when" type="datetime-local" required />
            </div>
            <div style="width:160px">
              <label for="repeat">Repeat</label>
              <select id="repeat">
                <option value="none">None</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
          </div>
          <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
            <button id="saveBtn" class="btn" type="button">Save Reminder</button>
            <button id="testBtn" class="btn secondary" type="button">Send Test (open mail)</button>
            <button id="clearBtn" class="btn secondary" type="button">Clear Form</button>
          </div>
          <p id="formHint" class="muted" style="margin-top:10px">Tips: Keep this page open for the scheduler to trigger reminders. Allow notifications when prompted.</p>
        </form>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="exportBtn" class="btn secondary">Export Reminders</button>
          <input id="importFile" type="file" accept=".json" style="display:none" />
          <button id="importBtn" class="btn secondary">Import Reminders</button>
          <button id="clearAllBtn" class="btn danger" title="Delete all reminders">Delete All</button>
        </div>
      </section>
      <section class="card" aria-label="Reminders list">
        <h2 style="margin-top:0;margin-bottom:6px">Your Reminders</h2>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
          <input id="search" type="text" placeholder="Search by email, subject or message" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02)" />
          <select id="filter">
            <option value="all">All</option>
            <option value="due">Due</option>
            <option value="future">Future</option>
            <option value="sent">Sent</option>
          </select>
        </div>
        <div id="list" class="list" aria-live="polite"></div>
        <footer>
          <div class="muted">Next check: <span id="nextCheck">--</span></div>
          <div class="controls">
            <div class="muted">Auto-check every <strong id="intervalLabel">15s</strong></div>
            <button id="toggleSched" class="btn secondary">Pause Scheduler</button>
          </div>
        </footer>
      </section>
    </div>
  </div>
  <script>
    const STORAGE_KEY = 'email_reminders_v1';
    const CHECK_INTERVAL = 15000;
    let reminders = [];
    let scheduler = null;
    let editingId = null;
    let nextCheckAt = null;
    let schedulerRunning = true;
    const recipientEl = document.getElementById('recipient');
    const subjectEl = document.getElementById('subject');
    const messageEl = document.getElementById('message');
    const whenEl = document.getElementById('when');
    const repeatEl = document.getElementById('repeat');
    const priorityEl = document.getElementById('priority');
    const saveBtn = document.getElementById('saveBtn');
    const testBtn = document.getElementById('testBtn');
    const clearBtn = document.getElementById('clearBtn');
    const listEl = document.getElementById('list');
    const statusEl = document.getElementById('status');
    const schedulerStateEl = document.getElementById('schedulerState');
    const nextCheckEl = document.getElementById('nextCheck');
    const intervalLabelEl = document.getElementById('intervalLabel');
    const toggleSchedBtn = document.getElementById('toggleSched');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFileEl = document.getElementById('importFile');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const searchEl = document.getElementById('search');
    const filterEl = document.getElementById('filter');
    intervalLabelEl.textContent = (CHECK_INTERVAL/1000) + 's';
    function uid(len = 10){
      return Math.random().toString(36).slice(2, 2+len);
    }
    function nowISO(){ return new Date().toISOString(); }
    function fmtDatetimeLocal(date){
      const dt = new Date(date);
      const pad = n => String(n).padStart(2,'0');
      return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    }
    function formatReadable(date){
      const dt = new Date(date);
      return dt.toLocaleString();
    }
async function addOrUpdateReminder(){
  const reminder = buildReminderFromForm();
  if(!reminder) return;

  await fetch('/api/reminders', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(reminder)
  });

  alert('Saved to database âœ…');
  loadRemindersFromServer();
}
async function loadRemindersFromServer(){
  const res = await fetch('/api/reminders');
  const data = await res.json();
  reminders = data;
  renderList();
}
testBtn.onclick = async () => {
  const r = buildReminderFromForm();
  if(!r) return;
  await fetch('/api/send-test', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(r)
  });
  alert('ðŸ“¨ Test email sent');
};
    function loadReminders(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        reminders = raw ? JSON.parse(raw) : [];
      } catch(e){
        console.error('Failed to load reminders', e);
        reminders = [];
      }
    }
    function saveReminders(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders));
    }
    function buildReminderFromForm(){
      const recipient = recipientEl.value.trim();
      const subject = subjectEl.value.trim();
      const message = messageEl.value.trim();
      const when = whenEl.value;
      const repeat = repeatEl.value;
      const priority = priorityEl.value;

      if(!recipient || !subject || !message || !when){
        alert('Please fill recipient, subject, message and date/time.');
        return null;
      }
      const ts = new Date(when).toISOString();
      if(isNaN(Date.parse(ts))){
        alert('Invalid date/time.');
        return null;
      }

      return {
        id: editingId || uid(12),
        recipient, subject, message, when: ts,
        repeat, priority,
        createdAt: editingId ? (reminders.find(r=>r.id===editingId)?.createdAt || nowISO()) : nowISO(),
        lastSentAt: null,
        sentCount: 0,
        active: true
      };
    }

    function addOrUpdateReminder(){
      const r = buildReminderFromForm();
      if(!r) return;
      if(editingId){
        const idx = reminders.findIndex(x=>x.id===editingId);
        if(idx>=0) reminders[idx] = {...reminders[idx], ...r};
        editingId = null;
      } else {
        reminders.push(r);
      }
      saveReminders();
      resetForm();
      renderList();
      setStatus('Saved');
    }

    function resetForm(){
      recipientEl.value = '';
      subjectEl.value = '';
      messageEl.value = '';
      whenEl.value = '';
      repeatEl.value = 'none';
      priorityEl.value = 'normal';
      editingId = null;
      saveBtn.textContent = 'Save Reminder';
    }

    function loadToForm(id){
      const r = reminders.find(x=>x.id===id);
      if(!r) return;
      recipientEl.value = r.recipient;
      subjectEl.value = r.subject;
      messageEl.value = r.message;
      whenEl.value = fmtDatetimeLocal(r.when);
      repeatEl.value = r.repeat || 'none';
      priorityEl.value = r.priority || 'normal';
      editingId = r.id;
      saveBtn.textContent = 'Update Reminder';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function deleteReminder(id){
      if(!confirm('Delete this reminder?')) return;
      reminders = reminders.filter(x=>x.id !== id);
      saveReminders();
      renderList();
      setStatus('Deleted');
    }
    function sendMail(r){
      const params = new URLSearchParams();
      if(r.subject) params.set('subject', r.subject);
      if(r.message) params.set('body', r.message + "\n\n(Automated reminder)");
      const mailto = `mailto:${encodeURIComponent(r.recipient)}?${params.toString()}`;
      window.open(mailto, '_blank');
    }
    function checkDueReminders(){
      if(!schedulerRunning) return;
      const now = new Date();
      const due = reminders.filter(r => r.active && Date.parse(r.when) <= now.getTime());
      if(due.length === 0) {
        setStatus('No reminders due');
        updateNextCheck();
        return;
      }
      due.forEach(r=>{
        const lastSent = r.lastSentAt ? Date.parse(r.lastSentAt) : 0;
        if(Math.abs(now.getTime() - lastSent) < 1000*30) {
          return;
        }
        notify(`${r.subject}`, `Reminder for ${r.recipient}\n${(r.message || '').slice(0,120)}`, () => {
          sendMail(r);
        });
        r.lastSentAt = now.toISOString();
        r.sentCount = (r.sentCount || 0) + 1;
        if(r.repeat && r.repeat !== 'none'){
          const next = computeNextOccurrence(r.when, r.repeat);
          if(next) r.when = next;
        } else {
          r.active = false;
        }
      });
      saveReminders();
      renderList();
      setStatus(`${due.length} reminder(s) processed`);
      updateNextCheck();
    }
    function computeNextOccurrence(isoWhen, repeat){
      const dt = new Date(isoWhen);
      if(isNaN(dt)) return null;
      const next = new Date(dt);
      if(repeat === 'daily'){
        next.setDate(next.getDate() + 1);
      } else if(repeat === 'weekly'){
        next.setDate(next.getDate() + 7);
      } else if(repeat === 'monthly'){
        next.setMonth(next.getMonth() + 1);
      } else return null;
      return next.toISOString();
    }
    function notify(title, body, onClick){
      if("Notification" in window){
        if(Notification.permission === "granted"){
          const n = new Notification(title, { body });
          n.onclick = ev => {
            ev.preventDefault();
            window.focus();
            if(typeof onClick === 'function') onClick();
            n.close();
          };
        } else if(Notification.permission !== "denied"){
          Notification.requestPermission().then(permission => {
            if(permission === "granted"){
              notify(title, body, onClick);
            }
          });
        }
      } else {
        if(confirm(title + "\n\n" + body + "\n\nOpen mail client?")){
          if(typeof onClick === 'function') onClick();
        }
      }
    }
    function renderList(){
      const q = searchEl.value.trim().toLowerCase();
      const filter = filterEl.value;
      const arr = reminders.slice().sort((a,b)=> Date.parse(a.when) - Date.parse(b.when));
      const nodes = arr.filter(r=>{
        if(filter === 'due' && !(r.active && Date.parse(r.when) <= Date.now())) return false;
        if(filter === 'future' && !(r.active && Date.parse(r.when) > Date.now())) return false;
        if(filter === 'sent' && !(r.sentCount && r.sentCount>0 && !r.active)) return false;
        if(!q) return true;
        return (r.recipient + ' ' + r.subject + ' ' + r.message).toLowerCase().includes(q);
      }).map(r => renderReminderNode(r));
      listEl.innerHTML = '';
      if(nodes.length === 0){
        listEl.innerHTML = `<div class="muted-block">No reminders yet. Create one in the left panel.</div>`;
        return;
      }
      nodes.forEach(n => listEl.appendChild(n));
    }
    function renderReminderNode(r){
      const wrap = document.createElement('div');
      wrap.className = 'reminder';
      const left = document.createElement('div');
      left.className = 'rem-left';
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = r.recipient.split('@')[0].slice(0,2).toUpperCase();
      const meta = document.createElement('div');
      meta.className = 'meta';
      const h3 = document.createElement('h3');
      h3.textContent = r.subject;
      const p = document.createElement('p');
      p.innerHTML = `<strong>${r.recipient}</strong> â€¢ ${formatReadable(r.when)} â€¢ ${r.repeat !== 'none' ? r.repeat : '<span style="opacity:0.8">one-time</span>'}`;
      meta.appendChild(h3);
      meta.appendChild(p);
      left.appendChild(avatar);
      left.appendChild(meta);
      const right = document.createElement('div');
      right.className = 'actions';
      const pri = document.createElement('div');
      pri.className = 'pill';
      pri.textContent = r.priority || 'normal';
      right.appendChild(pri);
      if(!r.active){
        const p2 = document.createElement('div');
        p2.className = 'pill';
        p2.textContent = `Inactive`;
        right.appendChild(p2);
      } else if(Date.parse(r.when) <= Date.now()){
        const due = document.createElement('div');
        due.className = 'pill due';
        due.textContent = 'Due';
        right.appendChild(due);
      } else {
        const soon = document.createElement('div');
        soon.className = 'pill';
        soon.textContent = 'Scheduled';
        right.appendChild(soon);
      }
      const editBtn = document.createElement('button');
      editBtn.className = 'btn secondary';
      editBtn.innerText = 'Edit';
      editBtn.onclick = () => loadToForm(r.id);
      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn';
      sendBtn.innerText = 'Send Now';
      sendBtn.onclick = () => {
        sendMail(r);
        r.lastSentAt = nowISO();
        r.sentCount = (r.sentCount || 0) + 1;
        saveReminders();
        renderList();
      };
      const delBtn = document.createElement('button');
      delBtn.className = 'btn secondary';
      delBtn.innerText = 'Delete';
      delBtn.onclick = () => deleteReminder(r.id);
      right.appendChild(editBtn);
      right.appendChild(sendBtn);
      right.appendChild(delBtn);
      wrap.appendChild(left);
      wrap.appendChild(right);
      return wrap;
    }
    function setStatus(text){
      statusEl.textContent = text;
      setTimeout(()=> {
        if(statusEl.textContent === text) statusEl.textContent = 'Idle';
      }, 3000);
    }
    function updateNextCheck(){
      nextCheckAt = new Date(Date.now() + CHECK_INTERVAL);
      nextCheckEl.textContent = nextCheckAt.toLocaleTimeString();
    }
    function startScheduler(){
      if(scheduler) clearInterval(scheduler);
      scheduler = setInterval(checkDueReminders, CHECK_INTERVAL);
      schedulerRunning = true;
      schedulerStateEl.textContent = 'Running';
      toggleSchedBtn.textContent = 'Pause Scheduler';
      updateNextCheck();
    }
    function stopScheduler(){
      if(scheduler) clearInterval(scheduler);
      scheduler = null;
      schedulerRunning = false;
      schedulerStateEl.textContent = 'Paused';
      toggleSchedBtn.textContent = 'Resume Scheduler';
      nextCheckEl.textContent = '--';
      setStatus('Scheduler paused');
    }
    function exportReminders(){
      const data = JSON.stringify(reminders, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reminders.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus('Exported');
    }
    function importRemindersFile(file){
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const parsed = JSON.parse(e.target.result);
          if(!Array.isArray(parsed)) throw new Error('Expected an array of reminders');
          const existingIds = new Set(reminders.map(r=>r.id));
          parsed.forEach(r => {
            if(!r.id) r.id = uid(12);
            if(!existingIds.has(r.id)) reminders.push(r);
          });
          saveReminders();
          renderList();
          setStatus('Imported');
        } catch(err){
          alert('Failed to import file: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    function init(){
      saveBtn.onclick = addOrUpdateReminder;
      testBtn.onclick = () => {
        const r = buildReminderFromForm();
        if(!r) return;
        sendMail({...r, message: r.message + '\n\n[Test email]'});
      };
      clearBtn.onclick = resetForm;
      exportBtn.onclick = exportReminders;
      importBtn.onclick = () => importFileEl.click();
      importFileEl.onchange = (ev) => {
        if(ev.target.files && ev.target.files[0]) importRemindersFile(ev.target.files[0]);
        ev.target.value = '';
      };
      clearAllBtn.onclick = () => {
        if(confirm('Delete ALL reminders? This cannot be undone.')) {
          reminders = [];
          saveReminders();
          renderList();
          setStatus('All cleared');
        }
      };
      toggleSchedBtn.onclick = () => {
        if(schedulerRunning) stopScheduler();
        else startScheduler();
      };
      searchEl.oninput = renderList;
      filterEl.onchange = renderList;
      loadReminders();
      renderList();
      startScheduler();
      if("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied"){
        Notification.requestPermission().then(p => {
          if(p === 'granted') setStatus('Notifications enabled');
        });
      }
      setInterval(() => {
        const total = reminders.length;
        const active = reminders.filter(r=>r.active).length;
        const due = reminders.filter(r=> r.active && Date.parse(r.when) <= Date.now()).length;
        document.getElementById('status').textContent = `${total} total, ${active} active, ${due} due`;
      }, 3000);
    }
    init();
    window._ERS = {
      getReminders: () => reminders,
      save: saveReminders,
      checkNow: checkDueReminders
    };
  </script>
</body>
</html>
